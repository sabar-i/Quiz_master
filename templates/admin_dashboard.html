{% extends "base.html" %}
{% block content %}
<h1>Admin Dashboard</h1>
<form method="GET" action="{{ url_for('admin.search') }}">
    <input type="text" name="query" placeholder="Search..." required>
    <select name="category">
        <option value="users">Users</option>
        <option value="subjects">Subjects</option>
        <option value="quizzes">Quizzes</option>
        <option value="questions">Questions</option>
    </select>
    <button type="submit">Search</button>
</form>


<!-- Users Table -->
<h2>Users</h2>
<table class="styled-table">
    <tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>
    {% for user in users %}
    <tr>
        <td>{{ user.full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.role }}</td>
        <td>
            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}">Edit</a>
            <a href="{{ url_for('admin.delete_user', user_id=user.id) }}" onclick="return confirm('Delete this user?');">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- Subjects Table -->
<h2>Subjects</h2>
<button onclick="document.getElementById('createSubjectForm').style.display='block'">Create Subject</button>
<br><br>  <!-- Line break added -->
<div id="createSubjectForm" style="display:none;">
    <form action="{{ url_for('admin.create_subject') }}" method="POST">
        <input type="text" name="name" placeholder="Subject Name" required>
        <textarea name="description" placeholder="Subject Description"></textarea>
        <button type="submit">Add Subject</button>
    </form>
</div>
<table class="styled-table">
    <tr><th>Name</th><th>Description</th><th>Actions</th></tr>
    {% for subject in subjects %}
    <tr>
        <td>{{ subject.name }}</td>
        <td>{{ subject.description }}</td>
        <td>
            <a href="{{ url_for('admin.edit_subject', subject_id=subject.id) }}">Edit</a>
            <a href="{{ url_for('admin.delete_subject', subject_id=subject.id) }}" onclick="return confirm('Delete this subject?');">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>
<!-- Chapters Table -->
<h2>Chapters</h2>

<!-- Button to Show Create Chapter Form -->
<button onclick="document.getElementById('createChapterForm').style.display='block'">Create Chapter</button>
<br><br>  <!-- Line break added -->

<!-- Create Chapter Form (Hidden by Default) -->
<div id="createChapterForm" style="display:none;">
    <form action="{{ url_for('admin.create_chapter') }}" method="POST">
        <input type="text" name="name" placeholder="Chapter Name" required>
        <textarea name="description" placeholder="Chapter Description"></textarea>
        <select name="subject_id" required>
            {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
            {% endfor %}
        </select>
        <button type="submit">Add Chapter</button>
    </form>
</div>

<!-- Chapters Table -->
<table class="styled-table">
    <tr><th>Name</th><th>Description</th><th>Subject</th><th>Actions</th></tr>
    {% for chapter in chapters %}
    <tr>
        <td>{{ chapter.name }}</td>
        <td>{{ chapter.description }}</td>
        <td>{{ chapter.subject.name }}</td>
        <td>
            <a href="{{ url_for('admin.edit_chapter', chapter_id=chapter.id) }}">Edit</a>
            <a href="{{ url_for('admin.delete_chapter', chapter_id=chapter.id) }}" onclick="return confirm('Delete this chapter?');">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>


<!-- Quizzes Table -->
<!-- Quizzes Table -->
<h2>Quizzes</h2>
<button onclick="document.getElementById('createQuizForm').style.display='block'">Create Quiz</button>
<br><br>

<!-- Create Quiz Form -->
<div id="createQuizForm" style="display:none;">
    <form action="{{ url_for('admin.create_quiz') }}" method="POST">
        <input type="text" name="title" placeholder="Quiz Title" required>

        <!-- Subject Selection -->
        <select id="subject" name="subject_id" required>
            <option value="">Select Subject</option>
            {% for subject in subjects %}
            <option value="{{ subject.id }}">{{ subject.name }}</option>
            {% endfor %}
        </select>

        <!-- Chapter Selection (Dynamically Populated) -->
        <select id="chapter" name="chapter_id" required>
            <option value="">Select Chapter</option>
            <!-- Chapters will be added dynamically based on selected subject -->
        </select>

        <input type="date" name="date_of_quiz" required>
        <input type="time" name="time_duration" required>
        <textarea name="remarks" placeholder="Remarks (if any)"></textarea>
        <button type="submit">Add Quiz</button>
    </form>
</div>

<script>
    document.getElementById("subject").addEventListener("change", function() {
        let subjectId = this.value;
        let chapterDropdown = document.getElementById("chapter");

        // Clear current options
        chapterDropdown.innerHTML = '<option value="">Select Chapter</option>';

        if (subjectId) {
            fetch(`/admin/get_chapters/${subjectId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                   let chapterDropdown = document.getElementById("chapter");
                   chapterDropdown.innerHTML = '<option value="">Select Chapter</option>'; // Clear previous options

                   if (data.length === 0) {  // ✅ Fix: data is an array
                     chapterDropdown.innerHTML = '<option value="">No Chapters Available</option>';
                   } else {
                     data.forEach(chapter => {  // ✅ Fix: Loop over `data`
                       let option = document.createElement("option");
                       option.value = chapter.id;
                       option.textContent = chapter.name;
                       chapterDropdown.appendChild(option);
                     });
                   }
                })
                .catch(error => {
                    console.error("Error loading chapters:", error);
                    chapterDropdown.innerHTML = '<option value="">Error loading chapters</option>';
                });
        }
    });
</script>
<table class="styled-table">
    <tr>
        <th>Title</th>
        <th>Chapter</th>
        <th>Date</th>
        <th>Time Duration</th>
        <th>Remarks</th>
        <th>Actions</th>
    </tr>
    {% for quiz in quizzes %}
    <tr>
        <td>{{ quiz.title }}</td>
        <td>{{ quiz.chapter.name }}</td>
        <td>{{ quiz.date_of_quiz }}</td>
        <td>{{ quiz.time_duration }}</td>
        <td>{{ quiz.remarks or 'N/A' }}</td>
        <td>
            <a href="{{ url_for('admin.edit_quiz', quiz_id=quiz.id) }}">Edit</a>
            <a href="{{ url_for('admin.delete_quiz', quiz_id=quiz.id) }}" onclick="return confirm('Delete this quiz?');">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>
<!-- Quiz Scores Table -->
<h2>Quiz Scores</h2>
<table class="styled-table">
    <tr>
        <th>Quiz Title</th>
        <th>User Name</th>
        <th>Timestamp</th>
        <th>Total Score</th>
        <th>Actions</th>  <!-- New Column for Edit/Delete -->
    </tr>
    {% for score in quiz_scores %}
    <tr>
        <td>{{ score.quiz.title }}</td>
        <td>{{ score.user.full_name }}</td>
        <td>{{ score.date_taken }}</td>
        <td>{{ score.score }}</td>
        <td>
            <!-- Edit Button -->
            <a href="{{ url_for('admin.edit_quiz_score', score_id=score.id) }}">Edit</a>
            
            <!-- Delete Button (with confirmation) -->
            <form action="{{ url_for('admin.delete_quiz_score', score_id=score.id) }}" method="POST" style="display:inline;">
                <button type="submit" onclick="return confirm('Are you sure you want to delete this score?');">Delete</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- Quiz Performance Chart -->
<h2>Quiz Performance</h2>
<div style="width: 80%; max-width: 600px; margin: auto;">
    <canvas id="quizPerformanceChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("quizPerformanceChart").getContext("2d");

        const quizTitles = {{ quiz_stats|map(attribute='title')|list|tojson }};
        const highestScores = {{ quiz_stats|map(attribute='highest')|list|tojson }};
        const lowestScores = {{ quiz_stats|map(attribute='lowest')|list|tojson }};
        const avgScores = {{ quiz_stats|map(attribute='average')|list|tojson }};

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: quizTitles,
                datasets: [
                    {
                        label: "Highest Score",
                        data: highestScores,
                        backgroundColor: "rgba(75, 192, 192, 0.7)",
                    },
                    {
                        label: "Lowest Score",
                        data: lowestScores,
                        backgroundColor: "rgba(255, 99, 132, 0.7)",
                    },
                    {
                        label: "Average Score",
                        data: avgScores,
                        backgroundColor: "rgba(54, 162, 235, 0.7)",
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>

<style>
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
    }
    .styled-table th, .styled-table td {
        border: 2px solid black;
        padding: 10px;
    }
    .styled-table th {
        background-color: #f4f4f4;
    }
</style>

{% endblock %}
